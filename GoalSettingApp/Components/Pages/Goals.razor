@page "/goals"
@attribute [Authorize]
@using GoalSettingApp.Services
@using GoalSettingApp.Extensions
@using GoalSettingApp.Components 

@inject GoalService GoalService
@rendermode InteractiveServer

<style>
    .search-container {
        width: 100%;
    }

    .input-mobile {
        max-width: 90%;
    }

    .small-text {
        font-size: .9em;
    }

    @@media (min-width: 768px) {
        .search-container {
            width: 75%;
        }

        .input-mobile {
            width: auto;
            max-width: 9em;
        }
    }
    .goals-container {
        overflow-x: auto;
    }

    .goals-table {
        table-layout: fixed;
        min-width: 1000px;
        width: 100%;
    }

    .col-complete { width: 8%; }
    .col-title { width: 12%; }
    .col-description { width: 24%; }
    .col-category { width: 10%; }
    .col-priority { width: 8%; }
    .col-due { width: 12%; }
    .col-created { width: 12%; }
    .col-actions { width: 14%; }
</style>

<PageTitle>Goals</PageTitle>

<h1>My Goals</h1>

<div class="search-container d-flex flex-column flex-md-row align-items-start gap-2 ">
    <div class="order-2 mb-1 order-md-1 col-md-3  align-self-start align-self-md-end">
        <button class="btn btn-primary " @onclick="OpenDialog">Add Goal</button>
    </div>
    <div class="order-1 mb-1 order-md-2 col-md-3 input-mobile">
        <label class="form-label">Title</label>
        <input type="text" class="form-control" @bind="_searchTitle" />
    </div>

    <div class="order-1 mb-1 order-md-2 col-md-3 input-mobile">
        <label class="form-label">Category</label>
        <input type="text" class="form-control" @bind="_searchCategory" />
    </div>
    <div class="order-1 mb-1 order-md-2 col-md-3 input-mobile">
        <label class="form-label">Priority</label>
        <select class="form-select" @bind="_searchPriority">
            <option value="">All</option>
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
        </select>
    </div>
    <div class="order-1 mb-1 order-md-2 col-md-1 align-self-start align-self-md-end">
        <button class="btn btn-primary mt-2 " @onclick="ApplyFilters">
            Search
        </button>
    </div>
</div>

@if (_showDialog)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5)">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Goal</h5>
                    <button type="button" class="btn-close" @onclick="CloseDialog"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" @bind="_newGoalTitle" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" @bind="_newGoalDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <input type="text" class="form-control" @bind="_newGoalCategory" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <select class="form-select" @bind="_newGoalPriority">
                            <option value="@PriorityLevel.Low">Low</option>
                            <option value="@PriorityLevel.Medium">Medium</option>
                            <option value="@PriorityLevel.High">High</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-control" @bind="_newGoalDueDate" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseDialog">Cancel</button>
                    <button class="btn btn-primary" @onclick="SaveAndClose">Save</button>
                </div>
            </div>
        </div>
    </div>
}

<div class="mb-4">

</div>

<div>
    <h3>Goal List</h3>
    @if (_goals.Count == 0)
    {
        <p><em>No goals yet. Add your first goal above!</em></p>
    }
    else
    {
        <div class="goals-container">
            <table class="table table-striped goals-table">
                <thead>
                    <tr>
                        <th class="col-complete">Mark Complete</th>
                        <th class="col-title">Title</th>
                        <th class="col-description">Description</th>
                        <th class="col-category">Category</th>
                        <th class="col-priority">Priority</th>
                        <th class="col-due">Due Date</th>
                        <th class="col-created">Created</th>
                        <th class="col-actions">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var goal in ActiveGoals)
                    {
                        <tr>
                            @if (_editingGoalId == goal.Id)
                            {
                                <td><input type="text" class="form-control" @bind="_editGoalTitle" /></td>
                                <td><textarea class="form-control" @bind="_editGoalDescription"></textarea></td>
                                <td><input type="text" class="form-control" @bind="_editGoalCategory" /></td>
                                <td>
                                    <select class="form-select" @bind="_editGoalPriority">
                                        <option value="@PriorityLevel.Low">Low</option>
                                        <option value="@PriorityLevel.Medium">Medium</option>
                                        <option value="@PriorityLevel.High">High</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="date" class="form-control" @bind="_editGoalDueDate" />
                                </td>
                                <td>@goal.CreatedAt.ToShortDateString()</td>
                                <td class="d-flex">
                                    <button class="btn btn-sm btn-success mb-1 mb-md-0"
                                        @onclick="() => SaveEdit(goal.Id)">Save</button>
                                    <button class="btn btn-sm btn-secondary" @onclick="CancelEdit">Cancel</button>
                                </td>
                            }
                            else
                            {
                                <td>
                                    <input type="checkbox" class="form-check-input" @onchange="() => ToggleCompletion(goal.Id, true)" />
                                </td>
                                <td class="table-text col-title">@goal.Title</td>
                                <td class="col-description">@goal.Description.FirstCharToUpper()</td>
                                <td class="col-category">@goal.Category.FirstCharToUpper()</td>
                                <td class="col-priority"><span class="badge bg-@GetPriorityColor(goal.Priority)">@goal.Priority</span></td>
                                <td class="col-due">@(goal.DueDate?.ToString("MMM d, yyyy") ?? "—")</td>
                                <td class="col-created">@goal.CreatedAt.ToString("MMM d, yyyy")</td>
                                <td class="col-actions">
                                    @* Link to display goal details dialog (OpenDialog) *@                                    
                                    <button class="btn btn-sm btn-info mb-1" @onclick="() => OpenGoalDetails(goal)">View</button>
                                    
                                    @*<button class="btn btn-sm btn-warning mb-1 mb-md-1 mb-lg-0"
                                        @onclick="() => StartEdit(goal)">Edit</button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteGoal(goal.Id)">Delete</button>*@
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>


@* ARCHIVED GOALS *@
<div>
@if (ArchivedGoals.Any())
{
    <h3 class="mt-5">Archived Goals</h3>
    <div class="goals-container">
        <table class="table table-striped goals-table">
            <thead>
                <tr>
                    <th class="col-title">Title</th>
                    <th class="col-description">Description</th>
                    <th class="col-category">Category</th>
                    <th class="col-priority">Priority</th>
                    <th class="col-due">Due Date</th>
                    <th class="col-created">Created</th>
                    <th class="col-actions">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var goal in ArchivedGoals)
                {
                    <tr class="text-muted">
                        <td>@goal.Title</td>
                        <td>@goal.Description.FirstCharToUpper()</td>
                        <td>@goal.Category.FirstCharToUpper()</td>
                        <td><span class="badge bg-@GetPriorityColor(goal.Priority)">@goal.Priority</span></td>
                        <td>@(goal.DueDate?.ToString("MMM d, yyyy") ?? "—")</td>
                        <td>@goal.CreatedAt.ToString("MMM d, yyyy")</td>
                        <td>
                            <button class="btn btn-sm btn-outline-secondary" 
                                @onclick="() => ToggleCompletion(goal.Id, false)">Restore</button>
                            <button class="btn btn-sm btn-danger" 
                                @onclick="() => DeleteGoal(goal.Id)">Delete</button>
                        </td>
                        
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
</div>

@* === GOAL DETAILS DIALOG (VIEW LANDING PAGE) === *@
@if (_showGoalDetails && _selectedGoal is not null)
{
    <GoalDialog 
        Goal="_selectedGoal"
        OnClose="CloseGoalDetails"
        OnConfirm="SaveGoalDetails"
        OnEdit="StartEditFromDialog"
        OnDelete="DeleteFromDialog" />
}

@code {

    private bool _showDialog = false;

    private void OpenDialog() => _showDialog = true;
    private void CloseDialog() => _showDialog = false;
    private List<Goal> _goals = new List<Goal>();

    // New goal fields
    private string _newGoalTitle = "";
    private string _newGoalDescription = "";
    private string _newGoalCategory = "";
    private PriorityLevel _newGoalPriority = PriorityLevel.Medium;
    private DateTime? _newGoalDueDate = DateTime.Today;

    // Edit goal fields
    private int? _editingGoalId = null;
    private string _editGoalTitle = "";
    private string _editGoalDescription = "";
    private string _editGoalCategory = "";
    private PriorityLevel _editGoalPriority = PriorityLevel.Medium;
    private DateTime? _editGoalDueDate = null;

    // Search fields
    private string _searchTitle = "";
    private string _searchCategory = "";
    private string _searchPriority = "";

    // Filtered list
    private List<Goal> _filteredGoals = new List<Goal>();
    private List<Goal> ActiveGoals => _filteredGoals.Where(g => !g.IsCompleted).ToList();
    private List<Goal> ArchivedGoals => _filteredGoals.Where(g => g.IsCompleted).ToList();

    private void ApplyFilters()
    {
        _filteredGoals = _goals
        .Where(goal =>
        (string.IsNullOrEmpty(_searchTitle) || goal.Title.Contains(_searchTitle, StringComparison.OrdinalIgnoreCase)) &&
        (string.IsNullOrEmpty(_searchCategory) || goal.Category.Contains(_searchCategory, StringComparison.OrdinalIgnoreCase)) &&
        (string.IsNullOrEmpty(_searchPriority) || goal.Priority.ToString() == _searchPriority)
        )
        .ToList();
    }

    private void ClearFilters()
    {
        _searchTitle = "";
        _searchCategory = "";
        _searchPriority = "";
        _filteredGoals = _goals;
    }

    protected override async Task OnInitializedAsync()
    {
        await RefreshGoalsAsync();
    }

    private async Task RefreshGoalsAsync()
    {
        _goals = await GoalService.GetAllGoalsAsync();
        ApplyFilters();
    }

    private async Task AddGoal()
    {
        if (!string.IsNullOrWhiteSpace(_newGoalTitle))
        {
            await GoalService.AddGoalAsync(_newGoalTitle, _newGoalDescription, _newGoalCategory, _newGoalPriority, _newGoalDueDate);

            // Clear form
            _newGoalTitle = "";
            _newGoalDescription = "";
            _newGoalCategory = "";
            _newGoalPriority = PriorityLevel.Medium;
            _newGoalDueDate = DateTime.Today;

            await RefreshGoalsAsync();
        }
    }

    private void StartEdit(Goal goal)
    {
        _editingGoalId = goal.Id;
        _editGoalTitle = goal.Title;
        _editGoalDescription = goal.Description;
        _editGoalCategory = goal.Category;
        _editGoalPriority = goal.Priority;
        _editGoalDueDate = goal.DueDate;
    }

    private async Task SaveEdit(int id)
    {
        await GoalService.EditGoalAsync(id, _editGoalTitle, _editGoalDescription, _editGoalCategory, _editGoalPriority, _editGoalDueDate);
        _editingGoalId = null;
        await RefreshGoalsAsync();
    }

    private void CancelEdit()
    {
        _editingGoalId = null;
    }

    private async Task DeleteGoal(int id)
    {
        await GoalService.DeleteGoalAsync(id);
        await RefreshGoalsAsync();
    }

    private string GetPriorityColor(PriorityLevel priority)
    {
        return priority switch
        {
            PriorityLevel.Low => "secondary",
            PriorityLevel.Medium => "warning",
            PriorityLevel.High => "danger",
            _ => "secondary"
        };
    }

    private async Task SaveAndClose()
    {
        await AddGoal();
        CloseDialog();
    }

    private async Task ToggleCompletion(int id, bool completed)
    {
        await GoalService.ToggleGoalCompletedAsync(id, completed);
        await RefreshGoalsAsync();
    }


    /* --- Goal Details Landing Page (Dialog) --  */
    private Goal? _selectedGoal = null;
    private bool _showGoalDetails = false;

    private void OpenGoalDetails(Goal goal)
    {
        _selectedGoal = goal;
        _showGoalDetails = true;
    }

    private void CloseGoalDetails()
    {
        _showGoalDetails = false;
        _selectedGoal = null;
    }

    private async Task SaveGoalDetails()
    {
        await GoalService.EditGoalAsync(
            _selectedGoal.Id,
            _selectedGoal.Title,
            _selectedGoal.Description,
            _selectedGoal.Category,
            _selectedGoal.Priority,
            _selectedGoal.DueDate
        );

        _showGoalDetails = false;
        await RefreshGoalsAsync();
    } 

    private void StartEditFromDialog(Goal goal)
    {
        _showGoalDetails = false;

        StartEdit(goal); 
    }

    private async Task DeleteFromDialog(int id)
    {
        _showGoalDetails = false;

        await DeleteGoal(id);
    }
}