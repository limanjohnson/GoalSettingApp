@page "/"
@attribute [Authorize]
@using Microsoft.AspNetCore.Components.Authorization
@using GoalSettingApp.Services
@using GoalSettingApp.Helpers
@inject GoalService GoalService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Dashboard</PageTitle>
<AuthorizeView>
    <Authorized>
        <h1>Hello, @context.User.Identity?.Name!</h1>
    </Authorized>
    <NotAuthorized>
        <h1>Hello, Guest!</h1>
    </NotAuthorized>
</AuthorizeView>

<div class="alert alert-primary mt-4 p-4 w-100">
    <h4 class="mb-2">Overall Goal Progress</h4>

    <p class="mb-1">
        <strong>@_completedCount</strong> of <strong>@_totalCount</strong> goals completed
        (@_progressPercentage%)
    </p>

    <div class="progress" style="height: 20px;">
        <div class="progress-bar"
             role="progressbar"
             style="width: @_progressPercentage%;"
             aria-valuenow="@_progressPercentage"
             aria-valuemin="0"
             aria-valuemax="100">
            @_progressPercentage%
        </div>
    </div>
</div>


@if (OverdueGoals.Any())
{
    <div class="alert alert-danger">
        You have @OverdueGoals.Count overdue goal@(OverdueGoals.Count > 1 ? "s" : "")!
    </div>
}

<div class="d-flex flex-column flex-lg-row justify-content-around gap-2 mt-4">
    <GoalTable 
        Title="Your High Priority Goals"
        EmptyMessage="You have no high priority goals! Looking Good!"
        Items="@_goals.Where(g => g.Priority == PriorityLevel.High && !g.IsCompleted)"
        Headers="@_headers">

        <RowTemplate Context="goal">
            <tr>
                <td>@goal.Title</td>
                <td>
                    <span class="badge bg-@PriorityBadgeHelper.GetPriorityColor(goal.Priority)">
                        @goal.Priority
                    </span>
                </td>
                <td>@goal.DueDate?.ToString("d")</td>
            </tr>
        </RowTemplate>
    </GoalTable>

    <GoalTable
        Title="Upcoming Due Dates"
        EmptyMessage="You have no due dates this week!"
        Items="@_goals.Where(g => g.DueDate != null && g.DueDate <= DateTime.Today.AddDays(7) && !g.IsCompleted)"
        Headers="@_headers">
    
        <RowTemplate Context="goal">
            <tr>
                <td>@goal.Title</td>
                <td>
                    <span class="badge bg-@PriorityBadgeHelper.GetPriorityColor(goal.Priority)">
                        @goal.Priority
                    </span>
                </td>
                <td>@goal.DueDate?.ToString("d")</td>
            </tr>
        </RowTemplate>

    </GoalTable>

    <GoalTable
        Title="Recurring Goals"
        EmptyMessage="You have no recurring goals."
        Items="@_goals.Where(g => g.Recurrence != RecurrenceType.None)"
        Headers="@_headers">

        <RowTemplate Context="goal">
            <tr>
                <td>@goal.Title</td>
                <td>@goal.Category</td>
                <td><span class="badge bg-info">@goal.Recurrence</span></td>
                <td>@goal.DueDate?.ToString("d")</td>
            </tr>
        </RowTemplate>

    </GoalTable>
</div>

<div class="week-calendar mt-4 mb-4">
    <h5>This Week</h5>
    <div class="d-flex justify-content-between gap-2">
    @foreach (var day in GetWeekDays())
    {
        var count = GetGoalCountForDay(day);
        var isToday = day.Date == DateTime.Today;
        <div class="w-25 day-cell text-center p-2 rounded @(isToday ? "bg-primary text-white" : "bg-light")">
            <div class="day-name small">@day.ToString("ddd")</div>
            <div class="day-number fw-bold">@day.Day</div>
            @if (count > 0)
            {
                <span class="badge @(count >= 3 ? "bg-danger" : count >= 2 ? "bg-warning" : "bg-success") mt-1">
                    @count
                </span>
            }
            else
            {
                <span class="badge bg-secondary mt-1 opacity-25">-</span>
            }
        </div>
    }
    </div>
</div>

<div>
    <button class="btn btn-primary" @onclick="GoToGoals">Add a Goal</button>
</div>




@code{
    private List<Goal> _goals = new List<Goal>();
    private List<string> _headers = new List<string> { "Title", "Priority", "Due Date" };
    private List<Goal> OverdueGoals => _goals
        .Where(g => !g.IsCompleted && g.DueDate.HasValue && g.DueDate.Value.Date < DateTime.Today)
        .ToList();
    // Progress calculation
    private int _completedCount;
    private int _totalCount;
    private int _progressPercentage;

    protected override async Task OnInitializedAsync()
    {
        _goals = await GoalService.GetAllGoalsAsync();

        _totalCount = _goals.Count;
        _completedCount = _goals.Count(g => g.IsCompleted);

        _progressPercentage = _totalCount == 0
            ? 0
            : (_completedCount * 100 / _totalCount);
    }

    // Get dates for mini calendar
    private List<DateTime> GetWeekDays()
    {
        var today = DateTime.Today;
        return Enumerable.Range(0, 7)
            .Select(i => today.AddDays(i))
            .ToList();
    }

    private int GetGoalCountForDay(DateTime day)
    {
        return _goals.Count(g => !g.IsCompleted && g.DueDate.HasValue && g.DueDate.Value.Date == day.Date);
    }

    // On click navigate to Goals page
    private void GoToGoals()
    {
        Navigation.NavigateTo("/goals");
    }
}